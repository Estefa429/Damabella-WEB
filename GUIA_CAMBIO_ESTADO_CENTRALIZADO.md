# ğŸ“˜ GUÃA: FunciÃ³n Centralizada para Cambio de Estado de Pedidos\n\n## ğŸ¯ Resumen Ejecutivo\n\nLos archivos creados proporcionan una **soluciÃ³n centralizada y Ãºnica** para manejar cambios de estado de pedidos:\n\n1. **`cambioEstadoCentralizado.ts`** - FunciÃ³n Ãºnica y validada: `cambiarEstadoPedidoCentralizado()`\n2. **`useCambioEstadoPedido.ts`** - Hook React para componentes\n\n**Ventajas:**\n- âœ… Un Ãºnico punto de entrada (sin duplicaciones)\n- âœ… Validaciones centralizadas\n- âœ… SincronizaciÃ³n automÃ¡tica con Ventas\n- âœ… Manejo de errores y logging\n- âœ… Control de ediciÃ³n automÃ¡tico\n- âœ… Funciona en formularios, detalles, acciones a granel\n\n---\n\n## ğŸ“‹ Tabla de Transiciones Permitidas\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚ Estado      â”‚ Destino     â”‚ AcciÃ³n                             â”‚\nâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”‚ Pendiente   â”‚ Completada  â”‚ Descuenta stock, crea venta âœ“      â”‚\nâ”‚ Pendiente   â”‚ Anulado     â”‚ Anula pedido âœ“                     â”‚\nâ”‚ Completada  â”‚ Anulado     â”‚ Devuelve stock, anula venta âœ“      â”‚\nâ”‚ Completada  â”‚ Pendiente   â”‚ âŒ BLOQUEADO (no se puede revertir)â”‚\nâ”‚ Anulado     â”‚ *           â”‚ âŒ BLOQUEADO (estado terminal)     â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n---\n\n## ğŸš€ Uso BÃ¡sico\n\n### 1. Usar directamente en servicios o eventos\n\n```typescript\nimport { cambiarEstadoPedidoCentralizado } from './services/cambioEstadoCentralizado';\nimport { crearVentaDesdePedido } from './services/ventaService';\n\n// En un evento o callback\nconst handleCompletarPedido = async (pedidoId: string) => {\n  const resultado = await cambiarEstadoPedidoCentralizado(\n    pedidoId,\n    'Completada',\n    {\n      // Callback: Crear venta cuando se completa\n      onSincronizarVentas: (pedido) => crearVentaDesdePedido(pedido),\n      \n      // Callback: Notificar al usuario\n      onNotificar: (tipo, mensaje) => {\n        if (tipo === 'exito') {\n          showSuccessToast(mensaje);\n        } else if (tipo === 'error') {\n          showErrorToast(mensaje);\n        }\n      },\n      \n      // Callback: Logging para debugging\n      onLog: (nivel, msg) => console.log(`[${nivel}] ${msg}`)\n    }\n  );\n\n  if (resultado.success) {\n    // Actualizar UI\n    setPedidos(prev => \n      prev.map(p => p.id === resultado.pedido?.id ? resultado.pedido : p)\n    );\n  }\n};\n```\n\n### 2. Usar con el hook en componentes React\n\n```typescript\nimport { useCambioEstadoPedido } from './hooks/useCambioEstadoPedido';\nimport { crearVentaDesdePedido } from './services/ventaService';\n\nfunction BotonesEstadoPedido({ pedido, onPedidoActualizado }: Props) {\n  const {\n    cargando,\n    error,\n    exito,\n    cambiarEstado,\n    limpiarMensajes,\n    puedeCompletarse,\n    puedeAnularse,\n    obtenerClaseEstado,\n    obtenerDescripcionEstado\n  } = useCambioEstadoPedido({\n    onSincronizarVentas: crearVentaDesdePedido,\n    onNotificar: (tipo, msg) => {\n      if (tipo === 'exito') setSuccess(msg);\n      if (tipo === 'error') setError(msg);\n    }\n  });\n\n  const handleCompletarPedido = async () => {\n    await cambiarEstado(pedido.id, 'Completada');\n    // El hook actualiza automÃ¡ticamente pedido.estado\n    onPedidoActualizado?.();\n  };\n\n  const handleAnularPedido = async () => {\n    await cambiarEstado(pedido.id, 'Anulado');\n    onPedidoActualizado?.();\n  };\n\n  return (\n    <div>\n      {/* Badge del estado */}\n      <span className={`px-3 py-1 rounded ${obtenerClaseEstado(pedido.estado)}`}>\n        {obtenerDescripcionEstado(pedido.estado)}\n      </span>\n\n      {/* Botones contextuales */}\n      <div className=\"flex gap-2 mt-4\">\n        <button\n          onClick={handleCompletarPedido}\n          disabled={cargando || !puedeCompletarse(pedido.estado)}\n          className=\"px-4 py-2 bg-green-600 text-white rounded disabled:opacity-50\"\n        >\n          {cargando ? 'Procesando...' : 'âœ“ Completar'}\n        </button>\n\n        {puedeAnularse(pedido.estado) && (\n          <button\n            onClick={handleAnularPedido}\n            disabled={cargando}\n            className=\"px-4 py-2 bg-red-600 text-white rounded disabled:opacity-50\"\n          >\n            âœ• Anular\n          </button>\n        )}\n      </div>\n\n      {/* Mensajes */}\n      {error && <div className=\"mt-2 text-red-600\">{error}</div>}\n      {exito && <div className=\"mt-2 text-green-600\">OperaciÃ³n exitosa</div>}\n    </div>\n  );\n}\n```\n\n---\n\n## ğŸ›¡ï¸ Control de EdiciÃ³n\n\n### Validadores incluidos\n\n```typescript\nimport {\n  puedeEditarse,\n  puedeAnularse,\n  puedeCompletarse,\n  esEstadoTerminal\n} from './services/cambioEstadoCentralizado';\n\n// En un componente de ediciÃ³n\nfunction FormularioPedido({ pedido }: Props) {\n  const permitirEdicion = puedeEditarse(pedido.estado);\n  const permitirAnular = puedeAnularse(pedido.estado);\n  const permitirCompletar = puedeCompletarse(pedido.estado);\n\n  if (!permitirEdicion) {\n    return <p>Este pedido no puede ser editado ({pedido.estado})</p>;\n  }\n\n  return (\n    <form>\n      {/* Los inputs solo estÃ¡n habilitados si estado es Pendiente */}\n      <input \n        name=\"cliente\"\n        disabled={!permitirEdicion}\n        defaultValue={pedido.clienteId}\n      />\n      {/* ... otros campos ... */}\n    </form>\n  );\n}\n```\n\n---\n\n## ğŸ“± Ejemplos de IntegraciÃ³n en Componentes Reales\n\n### Ejemplo 1: Tabla de Pedidos con Acciones\n\n```typescript\nfunction TablaPedidos({ pedidos }: Props) {\n  const [pedidosList, setPedidosList] = useState(pedidos);\n  const { cambiarEstado, cargando } = useCambioEstadoPedido({\n    onSincronizarVentas: crearVentaCallback,\n    onNotificar: showNotification\n  });\n\n  const handleAccion = async (pedidoId: string, accion: string) => {\n    if (accion === 'completar') {\n      await cambiarEstado(pedidoId, 'Completada');\n    } else if (accion === 'anular') {\n      await cambiarEstado(pedidoId, 'Anulado');\n    }\n    \n    // Recargar tabla\n    const actualizado = obtenerPedidoDelStorage(pedidoId);\n    setPedidosList(prev => \n      prev.map(p => p.id === actualizado?.id ? actualizado : p)\n    );\n  };\n\n  return (\n    <table>\n      <thead>\n        <tr>\n          <th>ID</th>\n          <th>Cliente</th>\n          <th>Estado</th>\n          <th>Acciones</th>\n        </tr>\n      </thead>\n      <tbody>\n        {pedidosList.map(pedido => (\n          <tr key={pedido.id}>\n            <td>{pedido.id}</td>\n            <td>{pedido.clienteId}</td>\n            <td>\n              <span className={obtenerClaseEstado(pedido.estado)}>\n                {pedido.estado}\n              </span>\n            </td>\n            <td>\n              {puedeCompletarse(pedido.estado) && (\n                <button\n                  onClick={() => handleAccion(pedido.id, 'completar')}\n                  disabled={cargando}\n                >\n                  Completar\n                </button>\n              )}\n              {puedeAnularse(pedido.estado) && (\n                <button\n                  onClick={() => handleAccion(pedido.id, 'anular')}\n                  disabled={cargando}\n                >\n                  Anular\n                </button>\n              )}\n            </td>\n          </tr>\n        ))}\n      </tbody>\n    </table>\n  );\n}\n```\n\n### Ejemplo 2: Modal de Cambio de Estado\n\n```typescript\nfunction ModalCambioEstado({ pedido, onClose, onExito }: Props) {\n  const [selectedEstado, setSelectedEstado] = useState(pedido.estado);\n  const { cambiarEstado, cargando, error } = useCambioEstadoPedido();\n\n  const handleAplicar = async () => {\n    if (selectedEstado === pedido.estado) {\n      onClose();\n      return;\n    }\n\n    await cambiarEstado(pedido.id, selectedEstado);\n    if (!error) {\n      onExito?.();\n      onClose();\n    }\n  };\n\n  return (\n    <div className=\"modal\">\n      <h2>Cambiar Estado de Pedido</h2>\n      <p>Estado actual: <strong>{pedido.estado}</strong></p>\n\n      <select\n        value={selectedEstado}\n        onChange={(e) => setSelectedEstado(e.target.value as any)}\n      >\n        <option value=\"Pendiente\">Pendiente</option>\n        {puedeCompletarse(pedido.estado) && (\n          <option value=\"Completada\">Completada</option>\n        )}\n        {puedeAnularse(pedido.estado) && (\n          <option value=\"Anulado\">Anulado</option>\n        )}\n      </select>\n\n      {error && <p className=\"error\">{error}</p>}\n\n      <button onClick={handleAplicar} disabled={cargando}>\n        {cargando ? 'Procesando...' : 'Aplicar Cambio'}\n      </button>\n    </div>\n  );\n}\n```\n\n---\n\n## ğŸ”„ Flujo de SincronizaciÃ³n Completo\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚  Usuario hace clic en \"Completar Pedido\"                   â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n                     â”‚\n                     â–¼\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚  useCambioEstadoPedido.cambiarEstado()                      â”‚\nâ”‚  â†’ llamada a cambiarEstadoPedidoCentralizado()             â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n                     â”‚\n        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n        â”‚                         â”‚\n        â–¼                         â–¼\n   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n   â”‚ ValidaciÃ³n  â”‚        â”‚ Cambio Estadoâ”‚\n   â”‚ TransiciÃ³n  â”‚        â”‚ (Pendiente â†’ â”‚\n   â”‚ (permitida) â”‚        â”‚ Completada)  â”‚\n   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n        â”‚                         â”‚\n        â”œâ”€ SI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\n        â”‚                         â”‚\n        â”‚                         â–¼\n        â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n        â”‚                  â”‚ Descuenta    â”‚\n        â”‚                  â”‚ Stock        â”‚\n        â”‚                  â”‚ (pedidoService\n        â”‚                  â”‚  .cambiar)   â”‚\n        â”‚                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜\n        â”‚                         â”‚\n        â”‚                         â–¼\n        â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n        â”‚                  â”‚ Sincroniza   â”‚\n        â”‚                  â”‚ a Ventas     â”‚\n        â”‚                  â”‚ (callback)   â”‚\n        â”‚                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜\n        â”‚                         â”‚\n        â”‚                         â–¼\n        â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n        â”‚                  â”‚ Notifica     â”‚\n        â”‚                  â”‚ Usuario      â”‚\n        â”‚                  â”‚ + Logging    â”‚\n        â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n        â”‚\n        â””â”€ NO â†’ Error Notificado\n```\n\n---\n\n## âœ… Checklist de ImplementaciÃ³n\n\n```\nâ˜ 1. Importar cambiarEstadoPedidoCentralizado en servicios\nâ˜ 2. Importar useCambioEstadoPedido en componentes React\nâ˜ 3. Configurar callback onSincronizarVentas\nâ˜ 4. Implementar callback onNotificar\nâ˜ 5. Usar validadores (puedeEditarse, puedeAnularse, etc)\nâ˜ 6. Deshabilitar botones segÃºn estado\nâ˜ 7. Actualizar UI despuÃ©s de cambio exitoso\nâ˜ 8. Mostrar mensajes de error\nâ˜ 9. Manejar estado cargando (loading)\nâ˜ 10. Verificar sincronizaciÃ³n con Ventas\n```\n\n---\n\n## ğŸ› Debugging\n\nLos logs incluyen prefijo `[CAMBIO_ESTADO]` para fÃ¡cil bÃºsqueda:\n\n```javascript\n// En la consola\nConsole â†’ Ctrl+Shift+K\nFiltro: \"CAMBIO_ESTADO\"\n\n// VerÃ¡s algo como:\n[info] [CAMBIO_ESTADO] Iniciando cambio de estado: ped_123 â†’ Completada\n[info] [CAMBIO_ESTADO] Sincronizando a Ventas: ped_123\n[info] [CAMBIO_ESTADO] Venta creada exitosamente\n[info] [CAMBIO_ESTADO] OperaciÃ³n completada: Pedido completado y venta creada\n```\n\n---\n\n## ğŸš¨ Manejo de Errores Comunes\n\n### Error: \"PEDIDO_NO_ENCONTRADO\"\n```\nâŒ El pedido no existe en localStorage\nâœ“ SoluciÃ³n: Verificar que el ID es correcto\n```\n\n### Error: \"TRANSICION_NO_PERMITIDA\"\n```\nâŒ El cambio de estado no es vÃ¡lido segÃºn las reglas\nâœ“ SoluciÃ³n: Revisar tabla de transiciones, verificar estado actual\n```\n\n### Error: \"ERROR_SINCRONIZACION_VENTAS\"\n```\nâŒ Fallo al crear venta en mÃ³dulo Ventas\nâœ“ SoluciÃ³n: Verificar que onSincronizarVentas funciona correctamente\n         Revisar estructura del pedido vs. estructura de venta\n```\n\n---\n\n## ğŸ“š Referencia RÃ¡pida\n\n| FunciÃ³n | Uso | Retorna |\n|---------|-----|----------|\n| `cambiarEstadoPedidoCentralizado()` | Cambiar estado (servicio) | `ResultadoCambioEstadoCentralizado` |\n| `useCambioEstadoPedido()` | Hook para React | `RetornoHook` |\n| `puedeEditarse()` | Â¿Se puede editar? | `boolean` |\n| `puedeAnularse()` | Â¿Se puede anular? | `boolean` |\n| `puedeCompletarse()` | Â¿Se puede completar? | `boolean` |\n| `esEstadoTerminal()` | Â¿Es terminal? | `boolean` |\n| `obtenerClaseEstado()` | CSS del estado | `string` |\n| `obtenerDescripcionEstado()` | Texto legible | `string` |\n\n---\n\n## ğŸ“ PrÃ³ximos Pasos\n\n1. **Integra el hook en PedidosManager.tsx**\n2. **Prueba todas las transiciones (Pendiente â†’ Completada â†’ Anulado)**\n3. **Verifica sincronizaciÃ³n con Ventas en ambos mÃ³dulos**\n4. **Implementa toasts/notificaciones visuales**\n5. **Agrega logs para auditorÃ­a (cambios de estado)**\n"